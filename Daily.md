# Daily Log

## 2022-7-2

今日收到回复，目前已经有一定的rust基础和riscv基础，准备从step1开始，补齐一下riscv系统结构知识。

#### 今日完成事务

1. 构建仓库 局域网git + gitee + github，添加基本ci/cd
2. 完成前期基本工作
3. 收集资料

#### 资料列表

1. osdev: https://wiki.osdev.org/Main_Page

2. rcore Tutorial v3: [rCore-Tutorial-Book-v3 3.6.0-alpha.1 文档](https://rcore-os.github.io/rCore-Tutorial-Book-v3/)

3. 项目要求: 

## 2022-7-3

rust智能指针图

![rust-containers.png](assets-Daily/e5e1f4239aefd1cdcdbece7f4488836714f4cb26.png)

## 今日完成事务

1. 完成lab0-0

2. 重新学习rust智能指针

## 2022-7-4

#### 今日完成事务

1. 完成rustlings

2. 完成test2

## 2022-7-5

#### 今日完成事务

1. 搜索musl libc相关信息

2. 为 自己写的byteos内核加入elf分析函数

## 2022-7-6

#### 今日完成事务

1. 了解内核调用规则 和 tls(线程局部储存) 

2. 搜寻 arg, envp, auxv传递规则资料

```c
argc, argv[0], ..., argv[argc-1], 0, environ[0], ..., environ[N], 0,
auxv[0].a_type, auxv[0].a_value, ..., 0
```

```
------------------------------------------------------------- 0x7fff6c845000
 0x7fff6c844ff8: 0x0000000000000000
        _  4fec: './stackdump\0'                      <------+
  env  /   4fe2: 'ENVVAR2=2\0'                               |    <----+
       \_  4fd8: 'ENVVAR1=1\0'                               |   <---+ |
       /   4fd4: 'two\0'                                     |       | |     <----+
 args |    4fd0: 'one\0'                                     |       | |    <---+ |
       \_  4fcb: 'zero\0'                                    |       | |   <--+ | |
           3020: random gap padded to 16B boundary           |       | |      | | |
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -|       | |      | | |
           3019: 'x86_64\0'                        <-+       |       | |      | | |
 auxv      3009: random data: ed99b6...2adcc7        | <-+   |       | |      | | |
 data      3000: zero padding to align stack         |   |   |       | |      | | |
. . . . . . . . . . . . . . . . . . . . . . . . . . .|. .|. .|       | |      | | |
           2ff0: AT_NULL(0)=0                        |   |   |       | |      | | |
           2fe0: AT_PLATFORM(15)=0x7fff6c843019    --+   |   |       | |      | | |
           2fd0: AT_EXECFN(31)=0x7fff6c844fec      ------|---+       | |      | | |
           2fc0: AT_RANDOM(25)=0x7fff6c843009      ------+           | |      | | |
  ELF      2fb0: AT_SECURE(23)=0                                     | |      | | |
auxiliary  2fa0: AT_EGID(14)=1000                                    | |      | | |
 vector:   2f90: AT_GID(13)=1000                                     | |      | | |
(id,val)   2f80: AT_EUID(12)=1000                                    | |      | | |
  pairs    2f70: AT_UID(11)=1000                                     | |      | | |
           2f60: AT_ENTRY(9)=0x4010c0                                | |      | | |
           2f50: AT_FLAGS(8)=0                                       | |      | | |
           2f40: AT_BASE(7)=0x7ff6c1122000                           | |      | | |
           2f30: AT_PHNUM(5)=9                                       | |      | | |
           2f20: AT_PHENT(4)=56                                      | |      | | |
           2f10: AT_PHDR(3)=0x400040                                 | |      | | |
           2f00: AT_CLKTCK(17)=100                                   | |      | | |
           2ef0: AT_PAGESZ(6)=4096                                   | |      | | |
           2ee0: AT_HWCAP(16)=0xbfebfbff                             | |      | | |
           2ed0: AT_SYSINFO_EHDR(33)=0x7fff6c86b000                  | |      | | |
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .        | |      | | |
           2ec8: environ[2]=(nil)                                    | |      | | |
           2ec0: environ[1]=0x7fff6c844fe2         ------------------|-+      | | |
           2eb8: environ[0]=0x7fff6c844fd8         ------------------+        | | |
           2eb0: argv[3]=(nil)                                                | | |
           2ea8: argv[2]=0x7fff6c844fd4            ---------------------------|-|-+
           2ea0: argv[1]=0x7fff6c844fd0            ---------------------------|-+
           2e98: argv[0]=0x7fff6c844fcb            ---------------------------+
 0x7fff6c842e90: argc=3 
```

## 2022-7-7

#### 今日完成事务

1. 将内核添加栈`Stack`管理结构

2. 对内核异常进行统一处理，优化代码结构

## 2022-7-8

#### 今日完成事务

1. 完成`lab1`

2. 搜索aux相关资料

## 2022-7-9

#### 今日完成事务

1. 在`manjaro`上编译`buildroot for linux`，并编译`libc-test`

2. 在本机上调试和在`qemu`上调试发现问题，原来对于映射只是简单的处理，在原文件的基础上映射导致存在未初始化的内存，因此出现问题

## 2022-7-10

#### 今日完成事务

1. 在昨天调试的基础上已经能够进入`__init_tp`

2. 修复部分映射错误问题

3. 目前`byte-os`已经能够进入`main`函数

#### 输出效果

> 目前没有添加参数

```shell
[INFO] 中断号: 96 调用地址: 0x14918
[INFO] 中断号: 64 调用地址: 0x14474
src/common/runtest.c:37: usage: (null) [-t timeoutsec] [-w wrapcmd] cmd [args..]
[INFO] 中断号: 94 调用地址: 0x14be4
[WARN] 未识别调用号 94
[INFO] 中断号: 93 调用地址: 0x14be4
[INFO] 剩余页表: 1421
panic: '已无任务'
```

目前还有`94`中断未支持

## 2022-7-10

#### 今日完成事务

1. 优化代码，添加相关数据

2. 设置需要启动的任务

## 2022-7-12

#### 今日完成事务

1. 搜索`musl`相关数据

2. 编译带有符号的测例，方便进行调试

## 2022-7-13

#### 今日完成事务

1. 完成基本程序的加载

2. 执行测例

3. 更新`fat32`支持，完善多文件和`fat`项读取。

## 2022-7-14

#### 完成事务

1. 完善资源获取与释放

2. 更新代码结构

3. 完善进程调度代码

4. 采用新的任务系统

## 2022-7-15 —— 2022-7-19

#### 完成事务

1. 更新设计模式并修改相关代码

2. 完成相关设计

3. 尝试使用新内核执行模式

#### 尝试另类的内核执行模式

> 传统的内核将内核执行与任务执行分隔开，在内核进入用户态后所有事务由一个`Interrupt`进行代理。在制作时感到跳跃性较强，因此我准备采用一种另类的设计模式，将每一个任务的执行作为一个`run`函数，在遇到中断时返回，通过在进入任务时保存任务相关寄存器，在发生中断时恢复相关寄存器并`ret`返回原位置。在此中模式下内核设计如同普通的程序一样，连续性较强。`run`后通过另一个`catch`函数进行处理。切换任务时仅需更换当前`task`即可。同样，在实现信号系统时可以直接去执行相应`task`的`run`实现软中断。

> 后面在实现内核异步时更加容易。

## 2022-7-20

#### 今日完成事务

1. 完善`File`相关设计，更新设计模式

2. 更新`Enum`方式匹配`FD`变更为`Dyn`方式匹配

3. 使用`HashMap`进行`FD`的存取

4. 实现`downcast`进行类型转换

## 2022-7-21

#### 今日完成事务

1. 重新修改`mmap`系统调用，支持虚拟地址的自分配

2. 更新`MapFlags`，使内存映射更加灵活

## 2022-7-22

#### 今日完成事务

1. 更新内存申请与释放方式，利用`rust`的`Drop`来实现内存的释放

2. 支持动态加载文件，支持加载动态链接功能

## 2022-7-23

#### 今日完成事务

1. 稳定文件树及相关功能，保证虚拟文件在`unlinkat`占用内存得到释放

2. 扩大`Stack`空间

3. 修改`task_queue`，保证任务顺利执行

4. 添加文件`lseek`功能

## 2022-7-24

#### 今日完成事务

1. 添加文件缓存相关功能，加快测试时速度，防止超时

2. 完成`statfs`相关测试案例

3. 更新栈大小

## 2022-7-25

#### 今日完成事务

1. 完善`sys_clone`，支持线程启动

2. 添加`tkill`系统调用，支持线程退出，

3. 更新汇编相应文件，防止偶发性汇编宏冲突

4. 修复内存加载异常导致的 `Illegal Instruction`

## 2022-7-26

#### 今日完成事务

1. 开始初步实现信号系统，添加`signal`函数执行系统调用

2. 更新`sigaction`和`sigmaskproc`

3. 对线程中`tid_address`进行更新，可以在任务退出时对数据进行重置

4. 添加`pthread`支持

#### 相关资料

1. [Linux的信号_凉冰难消一腔热血的博客-CSDN博客_linux 信号](https://blog.csdn.net/weixin_45676049/article/details/109256132)

## 2022-7-27

#### 今日完成事务

1. 修复信号系统，可以执行`tkill`系统调用

2. 可以执行信号并恢复

3. 修复`entry-dynamic.exe`导致的页错误

## 2022-7-28

#### 今日完成事务

1. 对比赛的内核进行测试

2. 修正`k210`平台可能出现的异常

#### 问题相关

`k210`平台的内存`0x80000000 - 0x80800000`经`CPU`缓冲，在内存进行频繁读取时，可能导致因为内存缓冲导致的异常。

## 2022-7-29

#### 今日完成事务

1. `lab2`和`lab3`

2. 调试比赛的内核 尝试寻找`pthread`相关内容

## 2022-7-30

#### 今日完成事务

1. 完成`lab4`和`lab5`
